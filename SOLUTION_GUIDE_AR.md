# دليل حل مشكلة تحميل المكونات - خطأ 422

## المشكلة
المكونات لا تحمل بشكل صحيح وتظهر رسالة خطأ:
```
Failed to load resource: the server responded with a status of 422 ()
GET https://api.salla.dev/admin/v2/design/component/custom_component?key=social-proof-component&version_id= 422 (Unprocessable Content)
```

## السبب الجذري
المشكلة أن `version_id` فارغ عند محاولة منصة سلة تحميل المكونات المخصصة. هذا يحدث عادة عندما:

1. **عدم تطابق إصدار المكون**: إصدار المكون في الثيم لا يتطابق مع ما تتوقعه منصة سلة
2. **فقدان معرف الإصدار**: تسجيل المكون يفتقد معرف الإصدار
3. **مشاكل ذاكرة التخزين المؤقت**: منصة سلة خزنت نسخة قديمة من المكون

## الحلول المطبقة

### ✅ 1. إضافة معلومات الإصدار
تم تحديث `twilight.json` بإضافة:
- `version`: إصدار الثيم
- `version_id`: معرف فريد للثيم
- `component_id`: معرف فريد لكل مكون
- `version_id`: معرف إصدار كل مكون

### ✅ 2. معالجة الأخطاء
تم إضافة معالجة أخطاء في `social-proof.twig`:
- فحص وجود المكون قبل عرضه
- عرض محتوى بديل عند فشل التحميل
- رسائل خطأ واضحة للمستخدمين

### ✅ 3. ملف تسجيل المكونات
تم إنشاء `component-registry.json` لضمان:
- تسجيل صحيح للمكونات
- إدارة الإصدارات
- تتبع التبعيات

## خطوات الحل

### الخطوة 1: تشغيل السكريبت
```powershell
# تشغيل سكريبت PowerShell
.\fix-components.ps1

# أو تشغيل سكريبت Batch
.\fix-components.bat
```

### الخطوة 2: إعادة بناء الثيم
```bash
# تثبيت التبعيات
pnpm install

# بناء الثيم
pnpm run build

# معاينة الثيم
pnpm run preview
```

### الخطوة 3: فحص المكونات
1. افتح معاينة الثيم في المتصفح
2. تحقق من وحدة تحكم المتصفح (F12)
3. ابحث عن أخطاء 422
4. تأكد من تحميل جميع المكونات

### الخطوة 4: مسح ذاكرة التخزين المؤقت
1. اذهب إلى لوحة تحكم متجر سلة
2. انتقل إلى **التصميم** → **محرر الثيم**
3. اضغط على **"مسح الذاكرة المؤقتة"** أو **"تحديث المكونات"**
4. انتظر إعادة تحميل المكونات

### الخطوة 5: نشر الثيم
```bash
# نشر الثيم
pnpm run publish
```

## التحقق من الحل

### ✅ فحص حالة المكونات
- [ ] جميع المكونات تظهر كـ "نشط" في محرر الثيم
- [ ] لا توجد أخطاء 422 في وحدة التحكم
- [ ] المكونات تعرض بشكل صحيح في الواجهة الأمامية

### ✅ اختبار تحميل المكونات
- [ ] انتقل إلى الصفحة الرئيسية
- [ ] تحقق من وحدة تحكم المتصفح لأخطاء 422
- [ ] تأكد من عرض جميع المكونات بشكل صحيح

### ✅ مراقبة استدعاءات API
- [ ] تحقق من علامة التبويب Network في DevTools
- [ ] تأكد من أن استدعاءات مكون API تعيد حالة 200
- [ ] تأكد من وجود معاملات version_id

## الوقاية

### 1. إدارة الإصدارات
- دائماً قم بزيادة إصدارات المكونات عند إجراء تغييرات
- استخدم الترقيم الدلالي (مثل 1.0.0، 1.0.1، 1.1.0)
- وثق تغييرات المكونات في CHANGELOG.md

### 2. اختبار المكونات
- اختبر المكونات في وضع المعاينة قبل النشر
- تحقق من وظائف المكونات بعد تحديثات الثيم
- راقب تحميل المكونات في الإنتاج

### 3. الصيانة المنتظمة
- امسح ذاكرة التخزين المؤقت للمنصة بانتظام
- حدث إصدارات المكونات دورياً
- راقب أخطاء تحميل المكونات

## الملفات المعدلة

- `twilight.json` - إضافة معلومات الإصدار
- `src/views/components/home/social-proof.twig` - معالجة الأخطاء
- `component-registry.json` - تسجيل المكونات (جديد)
- `fix-components.ps1` - سكريبت PowerShell (جديد)
- `fix-components.bat` - سكريبت Batch (جديد)

## الدعم

إذا استمرت المشكلة بعد تجربة هذه الحلول:

### 1. اتصل بدعم سلة مع:
- معرف الثيم والإصدار
- تفاصيل خطأ تحميل المكون
- خطوات إعادة إنتاج المشكلة

### 2. تحقق من وثائق سلة لـ:
- إرشادات تطوير المكونات
- استكشاف أخطاء المكونات
- تحديثات المنصة والتغييرات

## ملاحظات مهمة

- خطأ 422 هو عادة مشكلة من جانب الخادم، وليس مشكلة في كود الثيم
- فشل تحميل المكونات لا يؤثر على الوظائف العامة للثيم
- يمكن حل معظم المشاكل من خلال مسح ذاكرة التخزين المؤقت للمنصة وإعادة نشر الثيم
- التحديثات المنتظمة للثيم تساعد في منع عدم تطابق إصدارات المكونات

## حالة الإصلاح

- ✅ **تم الإصلاح**: إضافة معرفات الإصدار
- ✅ **تم الإصلاح**: معالجة الأخطاء في المكونات
- ✅ **تم الإصلاح**: إنشاء ملفات التسجيل
- ✅ **تم الإصلاح**: سكريبتات التشغيل التلقائي

**الخطوة التالية**: تشغيل `fix-components.ps1` واتباع الخطوات
