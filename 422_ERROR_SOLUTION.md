# حل مشكلة خطأ 422 - تحميل المكونات

## المشكلة
```
Failed to load resource: the server responded with a status of 422 ()
GET https://api.salla.dev/admin/v2/design/component/custom_component?key=social-proof-component&version_id= 422 (Unprocessable Content)
```

## السبب الجذري
المشكلة أن `version_id` فارغ في طلب API. هذا يحدث عندما:

1. **عدم تطابق إصدار المكون**: إصدار المكون في الثيم لا يتطابق مع ما تتوقعه منصة سلة
2. **فقدان معرف الإصدار**: تسجيل المكون يفتقد معرف الإصدار
3. **مشاكل ذاكرة التخزين المؤقت**: منصة سلة خزنت نسخة قديمة من المكون
4. **عدم تسجيل المكون**: المكون غير مسجل بشكل صحيح في منصة سلة

## الحلول المطبقة

### ✅ 1. إضافة معرفات فريدة
تم تحديث `twilight.json` بإضافة:
- `theme_id`: معرف فريد للثيم
- `platform_version`: إصدار منصة سلة
- `component_hash`: معرف فريد لكل مكون
- `component_version`: إصدار كل مكون

### ✅ 2. ملفات تسجيل المكونات
تم إنشاء:
- `salla-components.json`: تسجيل خاص بمنصة سلة
- `component-registry.json`: تسجيل عام للمكونات

### ✅ 3. معالجة الأخطاء
تم إضافة معالجة أخطاء في `social-proof.twig`:
- فحص وجود المكون قبل عرضه
- عرض محتوى بديل عند فشل التحميل

## خطوات الحل

### الخطوة 1: تشغيل السكريبت
```powershell
# تشغيل سكريبت PowerShell المتطور
.\fix-422-error.ps1

# أو تشغيل السكريبت الأساسي
.\fix-components.ps1
```

### الخطوة 2: إعادة بناء الثيم
```bash
# تثبيت التبعيات
pnpm install

# بناء الثيم
pnpm run build

# معاينة الثيم
pnpm run preview
```

### الخطوة 3: مسح ذاكرة التخزين المؤقت
1. اذهب إلى لوحة تحكم متجر سلة
2. انتقل إلى **التصميم** → **محرر الثيم**
3. اضغط على **"مسح الذاكرة المؤقتة"** أو **"تحديث المكونات"**
4. انتظر إعادة تحميل المكونات

### الخطوة 4: فحص تسجيل المكونات
1. تأكد من أن جميع المكونات تظهر كـ "نشط"
2. تحقق من أن مسارات المكونات صحيحة
3. تأكد من عدم وجود أخطاء في التكوين

### الخطوة 5: اختبار المكونات
1. افتح معاينة الثيم في المتصفح
2. تحقق من وحدة تحكم المتصفح (F12)
3. ابحث عن أخطاء 422
4. تأكد من تحميل جميع المكونات

### الخطوة 6: نشر الثيم
```bash
# نشر الثيم
pnpm run publish
```

## التحقق من الحل

### ✅ فحص حالة المكونات
- [ ] جميع المكونات تظهر كـ "نشط" في محرر الثيم
- [ ] لا توجد أخطاء 422 في وحدة التحكم
- [ ] المكونات تعرض بشكل صحيح في الواجهة الأمامية

### ✅ اختبار تحميل المكونات
- [ ] انتقل إلى الصفحة الرئيسية
- [ ] تحقق من وحدة تحكم المتصفح لأخطاء 422
- [ ] تأكد من عرض جميع المكونات بشكل صحيح

### ✅ مراقبة استدعاءات API
- [ ] تحقق من علامة التبويب Network في DevTools
- [ ] تأكد من أن استدعاءات مكون API تعيد حالة 200
- [ ] تأكد من وجود معاملات version_id

## الملفات المعدلة

- `twilight.json` - إضافة معرفات الإصدار والهاش
- `salla-components.json` - تسجيل خاص بمنصة سلة (جديد)
- `component-registry.json` - تسجيل عام للمكونات
- `src/views/components/home/social-proof.twig` - معالجة الأخطاء
- `fix-422-error.ps1` - سكريبت PowerShell متطور (جديد)

## استكشاف الأخطاء

### إذا استمرت المشكلة:

1. **تحقق من تسجيل المكونات**:
   - تأكد من أن جميع المكونات مسجلة في منصة سلة
   - تحقق من أن مسارات المكونات صحيحة

2. **مسح ذاكرة التخزين المؤقت**:
   - امسح ذاكرة التخزين المؤقت للمنصة
   - امسح ذاكرة التخزين المؤقت للمتصفح

3. **إعادة تسجيل المكونات**:
   - احذف المكونات من محرر الثيم
   - أعد إضافتها مرة أخرى

4. **اتصل بدعم سلة**:
   - قدم معرف الثيم والإصدار
   - قدم تفاصيل خطأ 422
   - قدم خطوات إعادة إنتاج المشكلة

## الوقاية

### 1. إدارة الإصدارات
- دائماً قم بزيادة إصدارات المكونات عند إجراء تغييرات
- استخدم الترقيم الدلالي (مثل 1.0.0، 1.0.1، 1.1.0)
- وثق تغييرات المكونات في CHANGELOG.md

### 2. اختبار المكونات
- اختبر المكونات في وضع المعاينة قبل النشر
- تحقق من وظائف المكونات بعد تحديثات الثيم
- راقب تحميل المكونات في الإنتاج

### 3. الصيانة المنتظمة
- امسح ذاكرة التخزين المؤقت للمنصة بانتظام
- حدث إصدارات المكونات دورياً
- راقب أخطاء تحميل المكونات

## ملاحظات مهمة

- خطأ 422 هو عادة مشكلة من جانب الخادم، وليس مشكلة في كود الثيم
- فشل تحميل المكونات لا يؤثر على الوظائف العامة للثيم
- يمكن حل معظم المشاكل من خلال مسح ذاكرة التخزين المؤقت للمنصة وإعادة نشر الثيم
- التحديثات المنتظمة للثيم تساعد في منع عدم تطابق إصدارات المكونات

## حالة الإصلاح

- ✅ **تم الإصلاح**: إضافة معرفات الإصدار والهاش
- ✅ **تم الإصلاح**: إنشاء ملفات تسجيل المكونات
- ✅ **تم الإصلاح**: معالجة الأخطاء في المكونات
- ✅ **تم الإصلاح**: سكريبتات التشغيل التلقائي

**الخطوة التالية**: تشغيل `fix-422-error.ps1` واتباع الخطوات
